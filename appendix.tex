\begin{appendices}

\chapter{Lua code snippets}
\label{app:code}

\section{The runtime support system}
\label{code:rts}

\begin{listing}[H]
\begin{luacode}
StateMachine = {
	EXECUTE_TRANSITION = 0,
	DISCARD_EVENT = 1,
	TERMINATE_SYSTEM = 2,
}

-- StateMachine.run
-- this field should be replaced by a coroutine created by the scheduler.
StateMachine.run = nil

-- StateMachine:fire()
-- this is the function called by the coroutine, and should implement all transitions specified for the state machine.
-- the transitions should be enclosed in a while(true) block to keep the coroutine alive.
-- use an if-else control structure to make sure processing starts at the beginning of the while block when the coroutine is resumed.
-- every transition must end with coroutine.yield(<status_message>) to give control back to the scheduler.
-- the while block should begin by retrieving the event that is due to be processed. 
function StateMachine:fire()
	error("'fire' function not yet implemented for this state machine!")
end

function StateMachine:new()
	local o = {}
	setmetatable(o, { __index = self })
	local data = {state = nil, id = nil} -- will be set upon instantiation of subclass
	
	o.state = function ()
		return data.state
	end
	
	o.set_state = function (state)
		data.state = state
	end
	
	o.set_id = function (id)
		data.id = id
	end
	
	o.id = function ()
		return data.id
	end
	
	return o
end

return StateMachine
\end{luacode}
	\caption{Lua code for the StateMachine prototype }
	\label{code:stm}
\end{listing}

\begin{listing}[H]
\begin{luacode}
Event = {}

function Event:new(state_machine_id, event_type, user_data)
	local o = {}
	setmetatable(o, { __index = self })
	local data = {state_machine_id = state_machine_id,
	              event_type = event_type, user_data = user_data}
	
	o.type = function ()
		return data.event_type
	end

	o.user_data = function ()
		return data.user_data
	end

	o.state_machine_id = function ()
		return data.state_machine_id
	end

	o.timer_id = function ()
		return data.timer_id
	end

	o.set_timer_id = function (timer_id)
		data.timer_id = timer_id
	end

	return o
end

return Event
\end{luacode}
	\caption{Lua code for the Event data structure }
	\label{code:event}
\end{listing}

\begin{listing}[H]
\begin{luacode}
Timer = {
	BASE = 0.001, -- number of time units for 1ms
}

function Timer.time()
	return os.time()
end

function Timer:new(id, expires, event)
	local o = {}
	setmetatable(o, { __index = self })
	local data = {id = id, expires = self.time()+expires, event = event}

	o.id = function ()
		return data.id
	end

	o.expires = function ()
		return data.expires
	end

	o.event = function ()
		return data.event
	end
	
	return o
end

return Timer
\end{luacode}
	\caption{Lua code for the Timer object }
	\label{code:timer}
\end{listing}

\begin{listing}[H]
\begin{luacode}
Scheduler = {}

function Scheduler.time()
	return os.time()
end

local function timers_cmp(t1, t2)
	if t1.expires() < t2.expires() then return true end
end

function Scheduler:new(system_type)
	local o = {}
	setmetatable(o, { __index = self })
	local active_event, timeout
	local state_machines = {}
	local event_queue = {}
	local timer_queue = {}

	o.add_state_machine = function (state_machine)
		state_machine.run = coroutine.create(state_machine.fire)
		state_machines[state_machine.id()] = state_machine
		print("State machine '"..state_machine.id().."' added to scheduler.")
	end

	o.remove_state_machine = function (state_machine)
		if state_machines[state_machine.id()] then
			result = true -- return true if state machine existed
			print("State machine '"..state_machine.id().."' removed from scheduler.")
		end
		state_machines[state_machine.id()] = nil
		return result
	end

	o.add_event = function (event)
		table.insert(event_queue, event)
	end

	o.get_next_event = function ()
		return table.remove(event_queue, 1)
	end

	o.set_active_event = function (event)
		active_event = event
	end

	o.get_active_event = function ()
		local event = active_event
		active_event = nil
		return event
	end

	o.add_timer = function (timer)
		if timer.expires() then
			table.insert(timer_queue, timer)
			table.sort(timer_queue, timers_cmp)
		end
	end

	o.stop_timer = function (id)
		for k, v in pairs(timer_queue) do
			if v.id() == id then
				table.remove(timer_queue, k)
				break
			end
		end
	end

	o.check_timers = function ()
		local now = o.time()
		if timer_queue[1] then
			if timer_queue[1].expires() < now then return table.remove(timer_queue, 1) end
		end
	end

-- continued on next page
\end{luacode}
	\label{code:scheduler}
	\caption{Lua code for the Scheduler }
\end{listing}

\begin{listing}[H]
\begin{luacode}
-- Scheduler code continued

	o.run = function (self)
		print("Scheduler running.")
		local success, status, state_machine
		local start = self.time()

		while(true) do

			local timer = self.check_timers()
			if timer then
				state_machine = state_machines[timer.event().state_machine_id()]
				self.set_active_event(timer.event())
				success, status = coroutine.resume(state_machine.run, state_machine)
				if not success then
					print("Success: "..tostring(success)..", status: "..status)
					self.remove_state_machine(state_machine)
					break
				elseif status == StateMachine.TERMINATE_SYSTEM then
					break
				end
			end

			local event = self.get_next_event()
			if event then
				state_machine = state_machines[event.state_machine_id()]
				self.set_active_event(event)
				success, status = coroutine.resume(state_machine.run, state_machine)
				if not success then
					print("Success: "..tostring(success)..", status: "..status)
					self.remove_state_machine(state_machine)
					break
				elseif status == StateMachine.TERMINATE_SYSTEM then
					break
				end
			end
		end
		print("Terminating system...")
	end

	return o
end

return Scheduler
\end{luacode}
\end{listing}

\chapter{Representation of the TrafficLightController state machine in Lua}
\label{app:traffic_light}

\begin{luacode}
StateMachine = require "state_machine"
Timer = require "timer"
Event = require "event"

local S0, S1, S2, S3, S4, S5 = "S0", "S1", "S2", "S3", "S4", "S5"
local YELLOW_DELAY = 3000000
local PEDESTRIAN_TIME = 10000000
local SAFE_TIME = 1000000

TrafficLightController = StateMachine:new()

TrafficLightController.events = {
	PEDESTRIAN_BUTTON_PRESSED = 1,
	YELLOW_TIMER_EXPIRED = 2,
	PEDESTRIANS_GO = 3,
	PEDESTRIAN_TIMER_EXPIRED = 4,
	CARS_GO = 5,
}

function TrafficLightController:new(id, scheduler)
	local o = {}
	setmetatable(o, { __index = self})
	o.data = {}
	o.data.id = id
	o.data.current_state = S0
	o.scheduler = scheduler
	scheduler:add_state_machine(o)
	return o
end

function TrafficLightController:fire()
	while(true) do
		local event = self.scheduler:get_active_event()
		local current_state = self:get_state()

		if event:type() == self.TERMINATE_SELF then
			break

		elseif current_state == S0 then
			if event:type() == self.events.PEDESTRIAN_BUTTON_PRESSED then
				print("Car light set to yellow.")
				local new_event = Event:new(self:id(), self.events.YELLOW_TIMER_EXPIRED)
				self.scheduler:add_timer(Timer:new(YELLOW_DELAY, self:id(), new_event))
				self:set_state(S1)
				coroutine.yield(StateMachine.EXECUTE_TRANSITION)

			else
				coroutine.yield(StateMachine.DISCARD_EVENT)
			end

-- continued on next page
\end{luacode}

\begin{listing}[htp]
\begin{luacode}
		elseif current_state == S1 then
			if event:type() == self.events.YELLOW_TIMER_EXPIRED then
				print("Car light set to red.")
				local new_event = Event:new(self:id(), self.events.PEDESTRIANS_GO)
				self.scheduler:add_timer(Timer:new(SAFE_TIME, self:id(), new_event))
				self.set_state(S2)
				coroutine.yield(StateMachine.EXECUTE_TRANSITION)

			else
				coroutine.yield(StateMachine.DISCARD_EVENT)
			end
			
		elseif current_state == S2 then
			if event:type() == self.events.PEDESTRIANS_GO then
				print("Pedestrian light set to green.")
				local new_event = Event:new(self:id(), self.events.PEDESTRIAN_TIMER_EXPIRED)
				self.scheduler:add_timer(Timer:new(PEDESTRIAN_TIME, self:id(), new_event))
				self:set_state(S3)
				coroutine.yield(StateMachine.EXECUTE_TRANSITION)

			else
				coroutine.yield(StateMachine.DISCARD_EVENT)
			end

		elseif current_state == S3 then
			if event:type() == self.events.PEDESTRIAN_TIMER_EXPIRED then
				print("Pedestrian light set to red.")
				local new_event = Event:new(self:id(), self.events.CARS_GO)
				self.scheduler:add_timer(Timer:new(SAFE_TIME, self:id(), new_event))
				self:set_state(S4)
				coroutine.yield(StateMachine.EXECUTE_TRANSITION)

			else
				coroutine.yield(StateMachine.DISCARD_EVENT)
			end

		elseif current_state == S4 then
			if event:type() == self.events.CARS_GO then
				print("Car light set to yellow.")
				local new_event = Event:new(self:id(), self.events.YELLOW_TIMER_EXPIRED)
				self.scheduler:add_timer(Timer:new(YELLOW_DELAY, self:id(), new_event))
				self:set_state(S5)
				coroutine.yield(StateMachine.EXECUTE_TRANSITION)

			else
				coroutine.yield(StateMachine.DISCARD_EVENT)
			end

		elseif current_state == S5 then
			if event:type() == self.events.YELLOW_TIMER_EXPIRED then
				print("Car light set to green.")
				self:set_state(S0)
				coroutine.yield(StateMachine.EXECUTE_TRANSITION)
			
			else
				coroutine.yield(StateMachine.DISCARD_EVENT)
			end

		else
			coroutine.yield(StateMachine.DISCARD_EVENT)
		end
	end
end

return TrafficLightController
\end{luacode}
\end{listing}

\begin{listing}
\begin{luacode}


\end{luacode}
\end{listing}

\begin{listing}
\begin{luacode}


\end{luacode}
\end{listing}

\end{appendices}